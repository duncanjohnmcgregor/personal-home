name: Continuous Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    env:
      POSTGRES_PRISMA_URL: ${{ secrets.POSTGRES_PRISMA_URL }}
      POSTGRES_URL_NON_POOLING: ${{ secrets.POSTGRES_URL_NON_POOLING }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
      SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
      SOUNDCLOUD_CLIENT_ID: ${{ secrets.SOUNDCLOUD_CLIENT_ID }}
      BEATPORT_CLIENT_ID: ${{ secrets.BEATPORT_CLIENT_ID }}
      BEATPORT_CLIENT_SECRET: ${{ secrets.BEATPORT_CLIENT_SECRET }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Restore Cached Build Artifacts
      uses: actions/cache@v3
      with:
        path: |
          .next
          node_modules/.prisma
          node_modules
          deployment-info.json
        key: ${{ runner.os }}-build-artifacts-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-artifacts-
        fail-on-cache-miss: true

    - name: Restore Additional Build Cache
      uses: actions/cache@v3
      with:
        path: |
          .next/cache
          node_modules/.cache
        key: ${{ runner.os }}-build-cache-${{ hashFiles('**/package-lock.json', '**/prisma/schema.prisma') }}
        restore-keys: |
          ${{ runner.os }}-build-cache-

    - name: Verify Cached Artifacts
      run: |
        echo "ğŸ” Verifying cached artifacts..."
        
        if [ ! -f "deployment-info.json" ]; then
          echo "âŒ Deployment info not found! CI may have failed or cache miss occurred."
          echo "â„¹ï¸ Run the CI workflow first to prepare deployment artifacts."
          exit 1
        fi
        
        echo "ğŸ“‹ Deployment Info:"
        cat deployment-info.json | jq '.'
        
        # Verify critical artifacts exist
        if [ ! -d ".next" ]; then
          echo "âŒ Build artifacts missing"
          exit 1
        fi
        
        if [ ! -d "node_modules/.prisma" ]; then
          echo "âŒ Prisma client missing"
          exit 1
        fi
        
        echo "âœ… All cached artifacts verified and ready"

    - name: Install Vercel CLI
      run: |
        echo "ğŸ“¦ Installing Vercel CLI..."
        npm install --global vercel@latest
        echo "âœ… Vercel CLI ready"

    - name: Verify Environment Variables
      run: |
        echo "ğŸ” Verifying production environment variables..."
        
        # Check if environment variables are properly set
        if [ -n "$POSTGRES_PRISMA_URL" ]; then
          echo "âœ… POSTGRES_PRISMA_URL is available"
        else
          echo "âŒ POSTGRES_PRISMA_URL is not available in environment"
          exit 1
        fi
        
        if [ -n "$POSTGRES_URL_NON_POOLING" ]; then
          echo "âœ… POSTGRES_URL_NON_POOLING is available"
        else
          echo "âŒ POSTGRES_URL_NON_POOLING is not available in environment"
          exit 1
        fi
        
        if [ -n "$NEXTAUTH_SECRET" ]; then
          echo "âœ… NEXTAUTH_SECRET is available"
        else
          echo "âŒ NEXTAUTH_SECRET is not available in environment"
          exit 1
        fi
        
        if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
          echo "âŒ VERCEL_TOKEN secret is not set!"
          echo ""
          echo "ğŸ”§ To fix this:"
          echo "1. Go to https://vercel.com/account/tokens"
          echo "2. Create a new token named 'GitHub Actions'"
          echo "3. Copy the token"
          echo "4. Go to GitHub repo â†’ Settings â†’ Secrets and variables â†’ Actions"
          echo "5. Add secret named 'VERCEL_TOKEN' with the token value"
          echo ""
          echo "ğŸ“– See VERCEL_SECRETS_SETUP.md for detailed instructions"
          exit 1
        else
          echo "âœ… VERCEL_TOKEN is configured"
        fi
        
        echo "âœ… All required environment variables verified"

    - name: Database Connection and Schema Deployment
      run: |
        echo "ğŸ—„ï¸ Setting up production database..."
        echo "===================================="
        
        # Test database connectivity first
        echo ""
        echo "ğŸ” Testing database connection..."
        
        # Create a lightweight connection test script
        cat > test-connection.js << 'EOF'
        const { PrismaClient } = require('@prisma/client')
        
        const prisma = new PrismaClient({
          log: ['error', 'warn'],
        })
        
        async function testConnection() {
          try {
            console.log('ğŸ” Testing database connection...')
            
            // Test basic connection
            await prisma.$connect()
            console.log('âœ… Database connection established')
            
            // Test query execution
            await prisma.$queryRaw`SELECT 1 as connection_test`
            console.log('âœ… Database query execution successful')
            
            console.log('âœ… Connection test passed!')
            process.exit(0)
            
          } catch (error) {
            console.error('âŒ Database connection failed:')
            console.error('Error details:', error.message)
            
            if (error.message.includes('ENOTFOUND')) {
              console.error('ğŸ” This appears to be a DNS/network issue')
            } else if (error.message.includes('authentication')) {
              console.error('ğŸ” This appears to be an authentication issue')
            } else if (error.message.includes('database') && error.message.includes('does not exist')) {
              console.error('ğŸ” Database does not exist')
            }
            
            process.exit(1)
          } finally {
            await prisma.$disconnect()
          }
        }
        
        testConnection()
        EOF
        
        # Run connection test
        if node test-connection.js; then
          echo "âœ… Database connection test passed"
        else
          echo "âŒ Database connection test failed"
          exit 1
        fi
        
        # Deploy migrations
        echo ""
        echo "ğŸš€ Deploying database migrations..."
        if npx prisma migrate deploy; then
          echo "âœ… Database migrations deployed successfully!"
        else
          echo "âš ï¸ Migration deploy failed, trying schema push..."
          if npx prisma db push --accept-data-loss; then
            echo "âœ… Database schema pushed successfully!"
          else
            echo "âŒ Both migration deploy and schema push failed"
            exit 1
          fi
        fi
        
        echo "âœ… Database setup completed successfully!"

    - name: Pull Vercel Environment Information
      run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

    - name: Build Project Artifacts for Vercel
      run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

    - name: Deploy to Vercel
      run: |
        echo "ğŸš€ Deploying to Vercel..."
        DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
        echo "âœ… Deployment completed"
        echo "deployment-url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
      id: deploy

    - name: Post-Deployment Health Check
      run: |
        echo "ğŸ¥ Running post-deployment health check..."
        echo "Waiting for deployment to stabilize..."
        sleep 10
        
        # Create health check script
        cat > post-deploy-health-check.js << 'EOF'
        const { PrismaClient } = require('@prisma/client')
        
        const prisma = new PrismaClient()
        
        async function healthCheck() {
          try {
            console.log('ğŸ” Testing database connectivity after deployment...')
            
            // Test connection
            await prisma.$connect()
            console.log('âœ… Database connection: OK')
            
            // Test basic operations
            const userCount = await prisma.user.count()
            console.log(`âœ… User table: accessible (${userCount} users)`)
            
            const playlistCount = await prisma.playlist.count()
            console.log(`âœ… Playlist table: accessible (${playlistCount} playlists)`)
            
            // Test performance
            const start = Date.now()
            await prisma.$queryRaw`SELECT 1 as test`
            const duration = Date.now() - start
            console.log(`âœ… Query performance: ${duration}ms`)
            
            if (duration > 3000) {
              console.log('âš ï¸ Warning: Query took longer than 3 seconds')
            }
            
            console.log('âœ… Post-deployment health check passed!')
            
          } catch (error) {
            console.error('âŒ Post-deployment health check failed:', error.message)
            process.exit(1)
          } finally {
            await prisma.$disconnect()
          }
        }
        
        healthCheck()
        EOF
        
        # Run health check
        if node post-deploy-health-check.js; then
          echo "âœ… Post-deployment database health check passed!"
        else
          echo "âŒ Post-deployment health check failed"
          echo "âš ï¸ Deployment may still be successful, but database connectivity issues detected"
        fi

    - name: Cleanup Temporary Files
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up temporary files..."
        rm -f test-connection.js post-deploy-health-check.js
        echo "âœ… Cleanup completed"

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "ğŸ“‹ Deployment Summary"
        echo "===================="
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Production deployment successful!"
          if [ -n "${{ steps.deploy.outputs.deployment-url }}" ]; then
            echo "ğŸŒ Deployment URL: ${{ steps.deploy.outputs.deployment-url }}"
          else
            echo "ğŸŒ Check Vercel dashboard for live URL"
          fi
          echo ""
          echo "ğŸ‰ Deployment completed in record time thanks to cached artifacts!"
          echo ""
          echo "ğŸ“Š Performance optimizations used:"
          echo "  âœ… Reused cached build artifacts from CI"
          echo "  âœ… Skipped redundant dependency installation"
          echo "  âœ… Skipped redundant build process"
          echo "  âœ… Streamlined database operations"
          echo "  âœ… Fast environment verification"
          echo ""
          echo "ğŸ”— Next steps:"
          echo "  1. Test authentication with Spotify"
          echo "  2. Verify playlist functionality"
          echo "  3. Monitor application performance"
        else
          echo "âŒ Production deployment failed"
          echo "Check the logs above for detailed error information"
          echo ""
          echo "ğŸ’¡ Troubleshooting tips:"
          echo "  1. Ensure CI workflow completed successfully"
          echo "  2. Verify all environment variables are set"
          echo "  3. Check database connectivity"
          echo "  4. Validate Vercel token permissions"
          exit 1
        fi
